<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dcits.galaxy.dtp.branch.BranchTransaction" >
    <sql id="dtpBranchColumns"> bxid, parentBxid, txid, indexInBranch, indexInTrunk, status, appGroup </sql>

	<insert id="save" parameterType="com.dcits.galaxy.dtp.branch.BranchTransaction">
    insert into dtp_branch (bxid, parentBxid, txid, indexInBranch, indexInTrunk, status, appGroup) 
	values(#{bxid}, #{parentBxid}, #{txid}, #{indexInBranch}, #{indexInTrunk}, #{status}, #{appGroup})
	</insert>

	<update id="updateStatus" parameterType="com.dcits.galaxy.dtp.branch.BranchTransaction">
	update dtp_branch set status=#{status} where bxid=#{bxid}
	</update>
	
	<select id="getBranch" resultType="com.dcits.galaxy.dtp.branch.BranchTransaction" parameterType="com.dcits.galaxy.dtp.branch.BranchTransaction">
	select  <include refid="dtpBranchColumns"/> from dtp_branch where bxid=#{bxid}
	</select>
	
	<select id="getAllByTxid" resultType="com.dcits.galaxy.dtp.branch.BranchTransaction" parameterType="com.dcits.galaxy.dtp.branch.BranchTransaction">
	select <include refid="dtpBranchColumns"/> from dtp_branch where txid=#{txid}
	</select>
	
	<select id="getAllByBxid" resultType="com.dcits.galaxy.dtp.branch.BranchTransaction" parameterType="com.dcits.galaxy.dtp.branch.BranchTransaction">
	select <include refid="dtpBranchColumns"/> from dtp_branch where parentBxid=#{bxid}
	</select>
	
	<select id="getUnCompletedDisorderByAppGroup" resultType="com.dcits.galaxy.dtp.branch.BranchTransaction" parameterType="com.dcits.galaxy.dtp.branch.BranchTransaction">
	select <include refid="dtpBranchColumns"/> from dtp_branch where parentBxid='unknow' and indexInTrunk <![CDATA[<]]> 0 and appGroup=#{appGroup} and txid in (
	select txid from dtp_trunk where (status='cancel' or status= 'confirm') and txid in (
	select distinct txid from dtp_branch where parentBxid='unknow' and indexInTrunk <![CDATA[<]]> 0 and appGroup=#{appGroup}))
	</select>
	
	<select id="getNeedSubmitByTxid" resultType="com.dcits.galaxy.dtp.branch.BranchTransaction" parameterType="com.dcits.galaxy.dtp.branch.BranchTransaction">
	select <include refid="dtpBranchColumns"/> from dtp_branch where parentBxid='unknow' and txid=#{txid} and status !='submit_complete' and status!='submit_invalid'
	</select>

	<select id="getNeedSubmitByBxid" resultType="com.dcits.galaxy.dtp.branch.BranchTransaction"	parameterType="com.dcits.galaxy.dtp.branch.BranchTransaction">
		select <include refid="dtpBranchColumns"/> from dtp_branch where parentBxid=#{bxid} and status !='submit_complete' and status !='submit_invalid'
	</select>
	
	<select id="getAllNeedSubmitBxidByTxid" resultType="String" parameterType="com.dcits.galaxy.dtp.branch.BranchTransaction">
		select distinct bxid from dtp_submitlog where bxid in ( 
		select bxid from dtp_branch where txid=#{txid} and status !='submit_complete' and status !='submit_invalid'	and status !='release_complete')
	</select>
</mapper>