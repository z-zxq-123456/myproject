<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dcits.ensemble.om.oms.dao.log.EcmTcecinStatDao">
  <!-- Created by admin on 2016/10/24 09:43:20. -->
  <select id="selectByPrimaryKey" parameterType="com.dcits.ensemble.om.oms.module.log.EcmTcecinStat" resultType="com.dcits.ensemble.om.oms.module.log.EcmTcecinStat">
    select *
    from ECM_TCECIN_STAT
    where TRACE_STAT_ID = #{traceStatId,jdbcType=INTEGER}
  </select>
    <select id="findPageList" parameterType="java.util.Map" resultType="com.dcits.ensemble.om.oms.module.log.EcmTcecinStat">
        select   *
        from ECM_TCECIN_STAT
        <where>
            <if test="baseParam.messageCode != null">
                AND  MESSAGE_CODE= #{baseParam.messageCode ,jdbcType=VARCHAR}
            </if>
            <if test="baseParam.messageType!= null">
                AND MESSAGE_TYPE = #{baseParam.messageType,jdbcType=VARCHAR}
            </if>
            <if test="baseParam.serviceCode!= null">
                AND SERVICE_CODE = #{baseParam.serviceCode,jdbcType=VARCHAR}
            </if>
            <if test="baseParam.startTime!=null">
                <if test="baseParam.endTime!=null">
                    AND <![CDATA[
                 TRACE_STAT_DATE >= #{baseParam.startTime,jdbcType=VARCHAR} and TRACE_STAT_DATE<= #{baseParam.endTime,jdbcType=VARCHAR}
      ]]>
                </if>
            </if>
        </where>
        order by  TRACE_STAT_DATE  DESC
    </select>
    <select id="findList" parameterType="java.util.Map" resultType="com.dcits.ensemble.om.oms.module.log.EcmTcecinStat">
        select   *
        from ECM_TCECIN_STAT
        <where>
            <if test="baseParam.messageCode != null">
                AND  MESSAGE_CODE= #{baseParam.messageCode ,jdbcType=VARCHAR}
            </if>
            <if test="baseParam.messageType!= null">
                AND MESSAGE_TYPE = #{baseParam.messageType,jdbcType=VARCHAR}
            </if>
            <if test="baseParam.serviceCode!= null">
                AND SERVICE_CODE = #{baseParam.serviceCode,jdbcType=VARCHAR}
            </if>
            <if test="baseParam.startTime!=null">
                  <if test="baseParam.endTime!=null">
                    AND <![CDATA[
                 TRACE_STAT_DATE >= #{baseParam.startTime,jdbcType=VARCHAR} and TRACE_STAT_DATE<= #{baseParam.endTime,jdbcType=VARCHAR}
      ]]>
                </if>
            </if>
        </where>
        group by  MESSAGE_CODE,MESSAGE_TYPE,SERVICE_CODE,TRACE_STAT_ID
        order by  TRACE_STAT_DATE  DESC
    </select>

    <select id="findListByTime" parameterType="java.util.Map" resultType="com.dcits.ensemble.om.oms.module.log.EcmTcecinStat">
        select   *
        from ECM_TCECIN_STAT
        <where>
            <if test="messageCode != null">
                AND  MESSAGE_CODE= #{messageCode ,jdbcType=VARCHAR}
            </if>
            <if test="messageType!= null">
                AND MESSAGE_TYPE = #{messageType,jdbcType=VARCHAR}
            </if>
            <if test="serviceCode!= null">
                AND SERVICE_CODE = #{serviceCode,jdbcType=VARCHAR}
            </if>
            <if test="startTime!=null">
                <if test="endTime!=null">
                    AND <![CDATA[
                 TRACE_STAT_DATE >= #{startTime,jdbcType=VARCHAR} and TRACE_STAT_DATE<= #{endTime,jdbcType=VARCHAR}
      ]]>
                </if>
            </if>
        </where>
        order by  TRACE_STAT_DATE  DESC
    </select>

    <select id="findTopList" parameterType="java.util.Map" resultType="com.dcits.ensemble.om.oms.module.log.EcmTcecinStat">
        select   TRACE_STAT_AMOUNT,TRACE_STAT_AVERTIME,TRACE_STAT_PEAKNUM,TRACE_STAT_OKPERC,TRACE_STAT_OKNUM,
                  TRACE_STAT_DATE,TRACE_STAT_ID,MESSAGE_CODE,MESSAGE_TYPE,SERVICE_CODE,(100-(substring_index( TRACE_STAT_OKPERC,'%',1)+0))  as traceStatFailperc,
                  (TRACE_STAT_AMOUNT-TRACE_STAT_OKNUM) as traceStatFailnum
        from ECM_TCECIN_STAT
        <where>
            <if test="startTime!=null">
                <if test="endTime!=null">
                    AND <![CDATA[
                 TRACE_STAT_DATE >= #{startTime,jdbcType=VARCHAR} and TRACE_STAT_DATE<= #{endTime,jdbcType=VARCHAR}
      ]]>
                </if>
            </if>
        </where>
        <if test="traceStatAmount!=null">
            order by substring_index( TRACE_STAT_AMOUNT,'ms',1)+0  desc
        </if>
        <if test="traceStatAvertime!=null">
            order by substring_index( TRACE_STAT_AVERTIME,'ms',1)+0 desc
        </if>
        <if test="traceStatPeaknum!=null">
            order by substring_index( TRACE_STAT_PEAKNUM,'ms',1)+0  desc
        </if>
        <if test="traceStatOkperc!=null">
            order by substring_index( TRACE_STAT_OKPERC,'%',1)+0
        </if>
        <if test="traceStatOknum!=null">
            order by substring_index( TRACE_STAT_OKNUM,'ms',1)+0  desc
        </if>
        <if test="traceStatFailnum!=null">
            order by substring_index( TRACE_STAT_OKNUM,'ms',1)+0
        </if>
        <if test="traceStatFailperc!=null">
            order by substring_index( TRACE_STAT_OKPERC,'%',1)+0
        </if>
    </select>

  <select id="findTcecinStat" parameterType="java.util.Map" resultType="com.dcits.ensemble.om.oms.module.log.EcmTcecinStat" databaseId="mysql">
    select  b.MESSAGE_CODE,b.MESSAGE_TYPE,b.SERVICE_CODE,count(b.TRACE_ID) AS traceStatAmount,
                 sum(if(c.TRACE_STATUS='0015001',1,0))  AS traceStatOknum,
                 (sum(if(c.TRACE_STATUS='0015001',1,0))/count(b.TRACE_ID))  AS traceStatOkperc,
                 floor(avg((UNIX_TIMESTAMP(c.TRACE_ENTIME)-UNIX_TIMESTAMP(a.TRACE_STTIME))*1000))   AS traceStatAvertime,
                 floor( max((UNIX_TIMESTAMP(if(c.TRACE_STATUS='0015001',c.TRACE_ENTIME,0))-UNIX_TIMESTAMP(if(c.TRACE_STATUS='0015001',a.TRACE_STTIME,0)))*1000))
                 AS traceStatPeaknum
    from  ECM_TCECHAIN_START  a
          left join ECM_TCECIN_BUS b  on a.TRACE_ID=b.TRACE_ID
          left join ECM_TCECIN_END c  on a.TRACE_ID=c.TRACE_ID
    where
            <![CDATA[
                       a.TRACE_STTIME  like '%${traceStatDate}%'
                 ]]>
    GROUP BY  b.MESSAGE_CODE,b.MESSAGE_TYPE,b.SERVICE_CODE
  </select>

    <select id="findTcecinStat" parameterType="java.util.Map" resultType="com.dcits.ensemble.om.oms.module.log.EcmTcecinStat" databaseId="oracle">
        select  b.MESSAGE_CODE,b.MESSAGE_TYPE,b.SERVICE_CODE,count(b.TRACE_ID) AS traceStatAmount,
            sum ( decode(c.TRACE_STATUS,'0015001',1,0) )  AS traceStatOknum,
            sum(decode(c.TRACE_STATUS,'0015001',1,0))/count(b.TRACE_ID)  AS traceStatOkperc,
            floor( avg( abs((( trunc ( to_timestamp ( c.TRACE_ENTIME , 'yyyy-mm-dd hh24:mi:ss.ff3' ) - 0 , 'mi' ) -
            trunc (( to_timestamp ( a.TRACE_STTIME , 'yyyy-mm-dd hh24:mi:ss.ff3' ) - 0 ), 'mi' )) * 24 * 60 * 60 +
            extract ( second from to_timestamp ( c.TRACE_ENTIME , 'yyyy-mm-dd hh24:mi:ss.ff3' ) -
            to_timestamp ( a.TRACE_STTIME , 'yyyy-mm-dd hh24:mi:ss.ff3' ))))*1000))   AS traceStatAvertime,

            floor( max( abs(((  trunc (  to_timestamp(DECODE(c.TRACE_STATUS,'0015001', c.TRACE_ENTIME,
            '2017-02-24 10:54:24.410'  ),'yyyy-mm-dd hh24:mi:ss.ff3' )-0,'mi') -
            trunc (  to_timestamp(DECODE(c.TRACE_STATUS,'0015001',a.TRACE_STTIME,
            '2017-02-24 10:54:24.410'  ),'yyyy-mm-dd hh24:mi:ss.ff3' )-0,'mi') ) * 24 * 60 * 60
            +
            extract ( second from to_timestamp(DECODE(c.TRACE_STATUS,'0015001', c.TRACE_ENTIME,
            '2017-02-24 10:54:24.410'  ),'yyyy-mm-dd hh24:mi:ss.ff3' ) -
            to_timestamp(DECODE(c.TRACE_STATUS,'0015001', a.TRACE_STTIME,
            '2017-02-24 10:54:24.410'  ),'yyyy-mm-dd hh24:mi:ss.ff3' ))))*1000))   AS traceStatPeaknum
        from  ECM_TCECHAIN_START  a
        left join ECM_TCECIN_BUS b  on a.TRACE_ID=b.TRACE_ID
        left join ECM_TCECIN_END c  on a.TRACE_ID=c.TRACE_ID
        where
        <![CDATA[
                       a.TRACE_STTIME  like '%${traceStatDate}%'
                 ]]>
        GROUP BY  b.MESSAGE_CODE,b.MESSAGE_TYPE,b.SERVICE_CODE
    </select>
    <insert id="insert" parameterType="com.dcits.ensemble.om.oms.module.log.EcmTcecinStat">
        insert into ECM_TCECIN_STAT
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="traceStatId != null">
                TRACE_STAT_ID,
            </if>
            <if test="traceStatDate != null">
                TRACE_STAT_DATE,
            </if>
            <if test="messageCode != null">
                MESSAGE_CODE,
            </if>
            <if test="messageType != null">
                MESSAGE_TYPE,
            </if>
            <if test="serviceCode != null">
                SERVICE_CODE,
            </if>
            <if test="traceStatAmount != null">
                TRACE_STAT_AMOUNT,
            </if>
            <if test="traceStatOknum != null">
                TRACE_STAT_OKNUM,
            </if>
            <if test="traceStatOkperc != null">
                TRACE_STAT_OKPERC,
            </if>
            <if test="traceStatAvertime != null">
                TRACE_STAT_AVERTIME,
            </if>
            <if test="traceStatPeaknum != null">
                TRACE_STAT_PEAKNUM,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="traceStatId != null">
                #{traceStatId,jdbcType=INTEGER},
            </if>
            <if test="traceStatDate != null">
                #{traceStatDate,jdbcType=VARCHAR},
            </if>
            <if test="messageCode != null">
                #{messageCode,jdbcType=VARCHAR},
            </if>
            <if test="messageType != null">
                #{messageType,jdbcType=VARCHAR},
            </if>
            <if test="serviceCode != null">
                #{serviceCode,jdbcType=VARCHAR},
            </if>
            <if test="traceStatAmount != null">
                #{traceStatAmount,jdbcType=VARCHAR},
            </if>
            <if test="traceStatOknum != null">
                #{traceStatOknum,jdbcType=VARCHAR},
            </if>
            <if test="traceStatOkperc != null">
                #{traceStatOkperc,jdbcType=VARCHAR},
            </if>
            <if test="traceStatAvertime != null">
                #{traceStatAvertime,jdbcType=VARCHAR},
            </if>
            <if test="traceStatPeaknum != null">
                #{traceStatPeaknum,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
</mapper>